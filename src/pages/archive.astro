---
import ArchivePanel from "@components/ArchivePanel.svelte";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPostsList } from "../utils/content-utils";

const rawPosts = await getSortedPostsList();

// 1. 修复类型并生成最终的文章列表
const sortedPostsList = rawPosts.map((p) => ({
    ...p,
    data: {
        ...p.data,
        // 转换 null 为 undefined
        category: p.data.category === null ? undefined : p.data.category,
    }
}));

// 2. ✅ 新增：提取所有标签和类别，这是 ArchivePanel 必需的 props
const allTags = new Set<string>();
const allCategories = new Set<string>();

for (const post of sortedPostsList) {
    // 提取 Tags
    for (const tag of post.data.tags) {
        allTags.add(tag);
    }
    // 提取 Categories (确保 category 存在且不是 undefined)
    if (post.data.category) {
        allCategories.add(post.data.category);
    }
}

const tags = Array.from(allTags);
const categories = Array.from(allCategories);
---

<MainGridLayout title={i18n(I18nKey.archive)}>
    {/* ✅ 修复：传递 tags 和 categories 属性 */}
    <ArchivePanel 
        sortedPosts={sortedPostsList} 
        tags={tags} 
        categories={categories} 
        client:only="svelte"
    ></ArchivePanel>
</MainGridLayout>